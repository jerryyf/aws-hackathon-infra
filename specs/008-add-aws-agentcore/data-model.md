# Data Model: AWS AgentCore Runtime Infrastructure

**Feature**: AWS AgentCore Runtime Infrastructure  
**Date**: 2025-10-10  
**References**: [spec.md](./spec.md), [plan.md](./plan.md)

## Overview

This document defines the core entities for AWS Bedrock AgentCore runtime infrastructure. These entities represent the infrastructure resources created and managed by CDK stacks.

---

## Entity Definitions

### 1. Agent Runtime

**Description**: Represents a deployed containerized agent application managed by AWS Bedrock AgentCore service.

**Attributes**:
- **runtime_id** (string): Unique identifier for the runtime, auto-generated by AgentCore service
- **runtime_arn** (string): Amazon Resource Name in format `arn:aws:bedrock-agentcore:<region>:<account>:runtime/<runtime-id>`
- **runtime_name** (string): Human-readable name following convention `<project>-agent-<environment>-<region>` (e.g., `hackathon-agent-test-us-east-1`)
- **endpoint_url** (string): HTTPS endpoint for runtime invocations in format `https://<runtime-id>.runtime.bedrock-agentcore.<region>.amazonaws.com`
- **status** (enum): Current runtime state
  - Values: `CREATING`, `ACTIVE`, `UPDATING`, `DELETING`, `FAILED`
  - Transitions: CREATING → ACTIVE (successful), CREATING → FAILED (deployment error)
- **runtime_version** (string): Version identifier for the runtime (default: "DEFAULT")
- **created_at** (timestamp): Runtime creation timestamp
- **updated_at** (timestamp): Last modification timestamp

**Relationships**:
- Contains one **Agent Runtime Artifact**
- References one **Execution Role** (IAM role ARN)
- Contains one **Network Configuration**

**Validation Rules**:
- runtime_name must match pattern `^[a-zA-Z0-9-_]{1,64}$`
- status must be ACTIVE before accepting invocations
- endpoint_url must use TLS 1.2 or higher (enforced by AWS)

**State Transitions**:
```
CREATING → ACTIVE (deployment successful)
CREATING → FAILED (insufficient permissions, invalid container URI, network errors)
ACTIVE → UPDATING (runtime version change)
UPDATING → ACTIVE (update successful)
UPDATING → FAILED (update error)
ACTIVE → DELETING (stack deletion)
DELETING → (resource removed)
```

---

### 2. Agent Runtime Artifact

**Description**: Container configuration defining the agent application to deploy.

**Attributes**:
- **container_uri** (string): ECR image URI in format `<account>.dkr.ecr.<region>.amazonaws.com/<repository>:<tag>`
- **container_cpu** (integer): CPU units allocated to the container (256, 512, 1024, 2048, 4096)
  - Default: 512 (0.5 vCPU)
  - Range: 256-4096 (AWS Fargate task limits apply)
- **container_memory** (integer): Memory in MiB allocated to the container
  - Default: 1024 (1 GB)
  - Range: 512-30720 (must be compatible with cpu value per Fargate rules)
- **environment_variables** (map<string, string>): Optional environment variables for the container
  - Restriction: Cannot contain secrets (use Secrets Manager ARNs instead)

**Relationships**:
- Belongs to one **Agent Runtime**
- References ECR repository from **Storage Stack**

**Validation Rules**:
- container_uri must be accessible by execution role (ecr:GetAuthorizationToken, ecr:BatchGetImage)
- container_uri must point to valid container image with /invocations or /mcp endpoint
- cpu/memory combination must match AWS Fargate valid pairings
- Image must be in same region as runtime deployment

---

### 3. Execution Role

**Description**: IAM role assumed by the agent runtime to access AWS services.

**Attributes**:
- **role_arn** (string): IAM role ARN in format `arn:aws:iam::<account>:role/<role-name>`
- **role_name** (string): IAM role name following convention `<project>-agent-execution-role-<environment>`
- **trust_policy** (JSON): IAM trust policy document allowing bedrock-agentcore.amazonaws.com service principal
- **permissions_policies** (list<string>): Managed or inline policy ARNs attached to the role
- **max_session_duration** (integer): Maximum session duration in seconds (3600-43200)
  - Default: 3600 (1 hour)

**Relationships**:
- Referenced by one or more **Agent Runtimes**
- Created in **Security Stack**

**Validation Rules**:
- trust_policy must include bedrock-agentcore.amazonaws.com service principal
- trust_policy must include source account and source ARN conditions (AWS Well-Architected security pillar)
- permissions_policies must include minimum permissions:
  - `bedrock:InvokeModel` (if agents use Bedrock LLMs)
  - `ecr:GetAuthorizationToken`, `ecr:BatchGetImage` (for container image pulls)
  - `logs:CreateLogGroup`, `logs:CreateLogStream`, `logs:PutLogEvents` (for CloudWatch logging)

**Trust Policy Structure** (see contracts/execution-role-trust.json):
```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Principal": {"Service": "bedrock-agentcore.amazonaws.com"},
    "Action": "sts:AssumeRole",
    "Condition": {
      "StringEquals": {"aws:SourceAccount": "<account-id>"},
      "ArnLike": {"aws:SourceArn": "arn:aws:bedrock-agentcore:<region>:<account>:*"}
    }
  }]
}
```

---

### 4. Network Configuration

**Description**: Defines how the agent runtime connects to network resources.

**Attributes**:
- **network_mode** (enum): Network connectivity mode
  - Values: `PUBLIC`, `VPC`
  - Spec requirement: VPC mode for production (P2), PUBLIC acceptable for testing (P1)
- **subnet_ids** (list<string>): VPC subnet IDs for runtime ENIs (required if network_mode=VPC)
  - Must reference PrivateAgent subnets (10.0.2.0/24 per existing architecture)
  - Must span multiple AZs (multi-AZ requirement from constitution)
- **security_group_ids** (list<string>): Security group IDs controlling runtime traffic (required if network_mode=VPC)
- **vpc_id** (string): VPC ID (derived from subnets, for reference only)

**Relationships**:
- Belongs to one **Agent Runtime**
- References VPC, subnets, and security groups from **Network Stack**

**Validation Rules**:
- If network_mode=VPC, subnet_ids and security_group_ids are required
- If network_mode=PUBLIC, subnet_ids and security_group_ids must be empty
- Subnets must be in PrivateAgent tier (no public IP assignment)
- Subnets must span at least 2 AZs (multi-AZ requirement)
- Security groups must allow:
  - **Egress**: HTTPS (443) to bedrock-agentcore VPC endpoint (if using VPC endpoint)
  - **Egress**: HTTPS (443) to AWS services (Bedrock, ECR, CloudWatch, Secrets Manager)
  - **Ingress**: None required (runtimes are invoked via AWS API, not direct network access)

---

### 5. VPC Interface Endpoint

**Description**: Private connection between VPC and AWS Bedrock AgentCore service.

**Attributes**:
- **endpoint_id** (string): VPC endpoint ID (format: `vpce-<identifier>`)
- **service_name** (string): AWS service name `com.amazonaws.<region>.bedrock-agentcore`
- **vpc_id** (string): VPC ID where endpoint is created
- **subnet_ids** (list<string>): Subnets for endpoint ENIs (should span all AZs)
- **security_group_ids** (list<string>): Security groups controlling endpoint traffic
- **private_dns_enabled** (boolean): Enable private DNS resolution
  - Default: true (recommended for automatic endpoint resolution)
- **endpoint_policy** (JSON): IAM policy restricting endpoint access
  - Default: Allow all actions from VPC (can be restricted to specific IAM principals)
- **dns_entries** (list<string>): DNS names for the endpoint (auto-generated)

**Relationships**:
- Created in **Network Stack**
- Referenced by **Agent Runtime** network configuration (implicitly via VPC)

**Validation Rules**:
- service_name must be valid for the deployment region
- subnet_ids must be in the VPC specified by vpc_id
- Security groups must allow inbound HTTPS (443) from agent runtime security groups
- If private_dns_enabled=true, VPC must have enableDnsHostnames and enableDnsSupport enabled

**Endpoint Policy Structure** (see contracts/vpc-endpoint-policy.json):
```json
{
  "Statement": [{
    "Effect": "Allow",
    "Principal": "*",
    "Action": "bedrock-agentcore:InvokeAgentRuntime",
    "Resource": "arn:aws:bedrock-agentcore:<region>:<account>:runtime/*"
  }]
}
```

---

## Entity Relationships Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                    Network Stack (VPC)                       │
│  ┌─────────────────┐         ┌──────────────────────────┐  │
│  │ VPC Interface   │         │ Subnets (PrivateAgent)   │  │
│  │ Endpoint        │◄────────│ - 10.0.2.0/26 (AZ1)      │  │
│  │ (bedrock-       │         │ - 10.0.2.64/26 (AZ2)     │  │
│  │  agentcore)     │         └──────────────────────────┘  │
│  └─────────────────┘                    ▲                   │
└──────────────────────────────────────────┼───────────────────┘
                                           │
┌──────────────────────────────────────────┼───────────────────┐
│              Security Stack              │                   │
│  ┌─────────────────────────────────┐    │                   │
│  │ Execution Role                  │    │                   │
│  │ - Trust Policy (bedrock-        │    │                   │
│  │   agentcore.amazonaws.com)      │    │                   │
│  │ - Permissions (Bedrock, ECR,    │    │                   │
│  │   CloudWatch)                   │    │                   │
│  └─────────────────────────────────┘    │                   │
│                  │                       │                   │
└──────────────────┼───────────────────────┼───────────────────┘
                   │                       │
┌──────────────────┼───────────────────────┼───────────────────┐
│   Storage Stack  │                       │                   │
│  ┌───────────────▼──────────┐            │                   │
│  │ ECR Repository           │            │                   │
│  │ - agent-images           │            │                   │
│  │ - KMS encrypted          │            │                   │
│  └──────────────────────────┘            │                   │
│                  │                       │                   │
└──────────────────┼───────────────────────┼───────────────────┘
                   │                       │
┌──────────────────▼───────────────────────▼───────────────────┐
│                   AgentCore Stack                             │
│  ┌─────────────────────────────────────────────────────┐     │
│  │ Agent Runtime                                       │     │
│  │ ┌─────────────────────────┐  ┌───────────────────┐ │     │
│  │ │ Agent Runtime Artifact  │  │ Network Config    │ │     │
│  │ │ - container_uri ────────┼──► - network_mode    │ │     │
│  │ │ - container_cpu         │  │ - subnet_ids ─────┼─┘     │
│  │ │ - container_memory      │  │ - security_groups │       │
│  │ └─────────────────────────┘  └───────────────────┘       │
│  │                                                           │
│  │ - runtime_arn                                            │
│  │ - endpoint_url                                           │
│  │ - status (CREATING → ACTIVE)                             │
│  └─────────────────────────────────────────────────────────┘│
└───────────────────────────────────────────────────────────────┘
```

---

## Configuration Examples

### Minimal Configuration (P1 - PUBLIC mode)
```python
runtime = CfnRuntime(
    self, "AgentRuntime",
    agent_runtime_name="hackathon-agent-test-us-east-1",
    agent_runtime_artifact={
        "containerConfiguration": {
            "containerUri": f"{account}.dkr.ecr.us-east-1.amazonaws.com/agent-images:v1.0.0"
        }
    },
    network_configuration={"networkMode": "PUBLIC"},
    role_arn=execution_role.role_arn
)
```

### Production Configuration (P2 - VPC mode, multi-AZ)
```python
runtime = CfnRuntime(
    self, "AgentRuntime",
    agent_runtime_name="hackathon-agent-prod-us-east-1",
    agent_runtime_artifact={
        "containerConfiguration": {
            "containerUri": f"{account}.dkr.ecr.us-east-1.amazonaws.com/agent-images:v1.0.0",
            "cpu": 1024,  # 1 vCPU
            "memoryLimitMiB": 2048  # 2 GB
        }
    },
    network_configuration={
        "networkMode": "VPC",
        "networkModeConfig": {
            "subnets": [
                "subnet-xxx-agent-az1",  # PrivateAgent AZ1
                "subnet-yyy-agent-az2"   # PrivateAgent AZ2
            ],
            "securityGroups": ["sg-zzz-agent-runtime"]
        }
    },
    role_arn=execution_role.role_arn,
    tags=[
        {"key": "Project", "value": "aws-hackathon"},
        {"key": "Environment", "value": "prod"},
        {"key": "Owner", "value": "platform-team"},
        {"key": "CostCenter", "value": "engineering"}
    ]
)
```

---

## Open Questions Resolved

1. **Container resource limits**: Default to 512 CPU / 1024 MiB for testing, 1024 CPU / 2048 MiB for production (based on Fargate best practices)
2. **VPC endpoint policy**: Start with allow-all from VPC, restrict to specific IAM principals in Phase 3 if needed
3. **Agent container source**: Use bedrock-agentcore-starter-toolkit for integration tests (smallest viable agent)
4. **Runtime naming**: Format `<project>-agent-<environment>-<region>` (e.g., `hackathon-agent-test-us-east-1`)
5. **Security group rules**: Agent runtime SG needs egress 443 to VPC endpoint SG; VPC endpoint SG needs ingress 443 from agent runtime SG
6. **Session management**: Generate session IDs using `uuid.uuid4().hex` (32 chars) + environment prefix (e.g., `test-<uuid>` = 37 chars)

---

**Next Steps**: Generate contracts in `contracts/` directory and create quickstart.md deployment guide.
